import{s as t,t as e,k as a,l as s,c as l,w as u,i as n,o as c,a as i,b as o,n as r,d,f as h,r as g,F as f,e as p,g as m,I as _,h as b,m as y,j as T}from"./index-DwyDR4I6.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const S=C({data:()=>({currentJudge:{name:"",groupType:"专家组",scoreData:""},groupTypes:["专家组","大众组"],groupTypeIndex:0,submittedTables:[],calculationResult:null,calculating:!1,lastCalculated:"",healthStatus:"unknown",healthMessage:"未知",totalProjects:0}),computed:{expertCount(){return this.submittedTables.filter((t=>"专家组"===t.groupType)).length},publicCount(){return this.submittedTables.filter((t=>"大众组"===t.groupType)).length},healthStatusClass(){return{"health-status":!0,healthy:"healthy"===this.healthStatus,unhealthy:"unhealthy"===this.healthStatus,error:"error"===this.healthStatus}}},methods:{onGroupTypeChange(t){this.groupTypeIndex=t.detail.value,this.currentJudge.groupType=this.groupTypes[this.groupTypeIndex]},parseScoreData:t=>t.split("\n").filter((t=>t.trim())).map((t=>t.split(/\t| {2,}/).filter((t=>t.trim())).map((t=>{const e=Number(t);return isNaN(e)?t.trim():e})))),async submitScoreTable(){if(this.currentJudge.name.trim())if(this.currentJudge.scoreData.trim())try{const e=this.parseScoreData(this.currentJudge.scoreData);if(e.length<2)return void t({title:"数据格式错误，请包含表头和数据行",icon:"none"});const a={judgeName:this.currentJudge.name,groupType:this.currentJudge.groupType,timestamp:(new Date).getTime(),scoreData:e};this.submittedTables.push(a),this.updateProjectCount(),this.currentJudge.name="",this.currentJudge.scoreData="",this.groupTypeIndex=0,this.currentJudge.groupType="专家组",this.calculationResult=null,t({title:"评分表提交成功！",icon:"success"})}catch(e){console.error("提交评分表失败:",e),t({title:"提交失败，请检查数据格式",icon:"none"})}else t({title:"请输入评分数据",icon:"none"});else t({title:"请输入评委姓名",icon:"none"})},updateProjectCount(){if(this.submittedTables.length>0){const t=this.submittedTables[0].scoreData;this.totalProjects=Math.max(0,t.length-1)}else this.totalProjects=0},async calculateScores(){if(0!==this.submittedTables.length){this.calculating=!0;try{const a=await e.callFunction({name:"vote-system",data:{action:"getRanking",data:{limit:50}}});console.log("计算排名结果:",a),200===a.result.code?(this.calculationResult={data:a.result.data,total_projects:a.result.data.length,total_judges:this.submittedTables.length,errors:0},this.lastCalculated=(new Date).toLocaleString(),t({title:"计算完成！",icon:"success"})):t({title:"计算失败: "+a.result.message,icon:"none"})}catch(a){console.error("计算失败:",a),t({title:"计算失败: "+a.message,icon:"none"})}finally{this.calculating=!1}}else t({title:"请先提交评分表",icon:"none"})},async checkHealth(){try{200===(await e.callFunction({name:"vote-system",data:{action:"testConnection"}})).result.code?(this.healthStatus="healthy",this.healthMessage="正常"):(this.healthStatus="unhealthy",this.healthMessage="异常")}catch(t){this.healthStatus="error",this.healthMessage="连接失败"}},removeTable(e){a({title:"确认删除",content:"确定要删除这份评分表吗？",success:a=>{a.confirm&&(this.submittedTables.splice(e,1),this.updateProjectCount(),this.calculationResult=null,t({title:"删除成功",icon:"success"}))}})},exportResults(){if(!this.calculationResult)return;const e=["排名,项目名称,总分",...this.calculationResult.data.map(((t,e)=>`${e+1},${t.项目名称||t.name},${(t.总分||t.finalScore||0).toFixed(2)}`))].join("\n");s({data:e,success:()=>{t({title:"结果已复制到剪贴板",icon:"success"})}})},async clearAllData(){a({title:"确认清空",content:"这将清空所有评分数据，此操作不可恢复！",success:async a=>{if(a.confirm)try{const a=await e.callFunction({name:"vote-system",data:{action:"clearAllScores"}});if(200!==a.result.code)throw new Error(a.result.message);this.submittedTables=[],this.calculationResult=null,this.totalProjects=0,t({title:"数据清空成功",icon:"success"})}catch(s){console.error("清空数据失败:",s),t({title:"清空失败: "+s.message,icon:"none"})}}})},async debugData(){try{const a=await e.callFunction({name:"vote-system",data:{action:"debugData"}});console.log("数据库调试信息:",a.result),t({title:"调试信息已输出到控制台",icon:"none"})}catch(a){console.error("调试失败:",a)}},formatTime(t){const e=new Date(t),a=new Date,s=new Date(a.getFullYear(),a.getMonth(),a.getDate()),l=new Date(s);return l.setDate(l.getDate()-1),e>=s?`今天 ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`:e>=l?`昨天 ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`:`${e.getMonth()+1}/${e.getDate()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},addTestData(){this.currentJudge.name="测试评委_"+Math.floor(100*Math.random()),this.currentJudge.groupType=Math.random()>.5?"专家组":"大众组",this.groupTypeIndex="专家组"===this.currentJudge.groupType?0:1,this.currentJudge.scoreData="序号 项目名称 技术创新性 商业模式 团队能力 路演表现 社会价值\n1 智能农业项目 25 20 18 12 8\n2 医疗AI平台 28 22 16 13 9\n3 智慧城市系统 26 21 17 14 7\n4 新能源技术 24 19 15 11 6\n5 区块链应用 27 23 19 15 8"}},onLoad(){this.checkHealth()}},[["render",function(t,e,a,s,C,S){const k=m,D=n,x=_,w=b,j=y,J=T;return c(),l(D,{class:"container"},{default:u((()=>[i(D,{class:"header uni-card"},{default:u((()=>[i(k,{class:"title"},{default:u((()=>[o("评分管理系统")])),_:1}),i(D,{class:r(["health-status",S.healthStatusClass])},{default:u((()=>[i(k,{class:"status-text"},{default:u((()=>[o("后端服务: "+d(C.healthMessage),1)])),_:1})])),_:1},8,["class"])])),_:1}),i(D,{class:"upload-section uni-card"},{default:u((()=>[i(k,{class:"section-title"},{default:u((()=>[o("上传评分表")])),_:1}),i(D,{class:"upload-form"},{default:u((()=>[i(D,{class:"input-group"},{default:u((()=>[i(k,{class:"uni-label"},{default:u((()=>[o("评委姓名：")])),_:1}),i(x,{modelValue:C.currentJudge.name,"onUpdate:modelValue":e[0]||(e[0]=t=>C.currentJudge.name=t),class:"uni-input",placeholder:"请输入评委姓名",maxlength:"20"},null,8,["modelValue"])])),_:1}),i(D,{class:"input-group"},{default:u((()=>[i(k,{class:"uni-label"},{default:u((()=>[o("评委组别：")])),_:1}),i(w,{onChange:S.onGroupTypeChange,value:C.groupTypeIndex,range:C.groupTypes},{default:u((()=>[i(D,{class:"picker-display"},{default:u((()=>[o(d(C.groupTypes[C.groupTypeIndex]),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1}),i(D,{class:"input-group"},{default:u((()=>[i(k,{class:"uni-label"},{default:u((()=>[o("评分表数据：")])),_:1}),i(j,{modelValue:C.currentJudge.scoreData,"onUpdate:modelValue":e[1]||(e[1]=t=>C.currentJudge.scoreData=t),class:"score-data-textarea",placeholder:"请粘贴Excel数据（制表符分隔）\n格式示例：\n序号 项目名称 技术创新性 商业模式 团队能力 路演表现 社会价值\n1 项目A 25 20 18 12 8\n2 项目B 28 22 16 13 9",maxlength:"-1","show-confirm-bar":!1},null,8,["modelValue"])])),_:1}),i(D,{class:"action-buttons"},{default:u((()=>[i(J,{onClick:S.submitScoreTable,class:"uni-btn uni-btn-primary"},{default:u((()=>[o("提交评分表")])),_:1},8,["onClick"]),i(J,{onClick:S.addTestData,class:"uni-btn uni-btn-warning"},{default:u((()=>[o("添加测试数据")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1}),i(D,{class:"submitted-section uni-card"},{default:u((()=>[i(D,{class:"section-header"},{default:u((()=>[i(k,{class:"section-title"},{default:u((()=>[o("已提交的评分表")])),_:1}),i(k,{class:"section-subtitle"},{default:u((()=>[o("共 "+d(C.submittedTables.length)+" 份",1)])),_:1})])),_:1}),i(D,{class:"table-list"},{default:u((()=>[(c(!0),h(f,null,g(C.submittedTables,((t,e)=>(c(),l(D,{key:e,class:"table-item"},{default:u((()=>[i(D,{class:"table-info"},{default:u((()=>[i(k,{class:"judge-name"},{default:u((()=>[o(d(t.judgeName),1)])),_:2},1024),i(D,{class:"table-meta"},{default:u((()=>[i(k,{class:r(["group-type",t.groupType])},{default:u((()=>[o(d(t.groupType),1)])),_:2},1032,["class"]),i(k,{class:"submit-time"},{default:u((()=>[o(d(S.formatTime(t.timestamp)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),i(J,{onClick:t=>S.removeTable(e),class:"delete-btn"},{default:u((()=>[o("删除")])),_:2},1032,["onClick"])])),_:2},1024)))),128)),0===C.submittedTables.length?(c(),l(D,{key:0,class:"empty-state"},{default:u((()=>[i(k,{class:"empty-text"},{default:u((()=>[o("暂无已提交的评分表")])),_:1})])),_:1})):p("",!0)])),_:1})])),_:1}),i(D,{class:"stats-section uni-card"},{default:u((()=>[i(k,{class:"section-title"},{default:u((()=>[o("统计信息")])),_:1}),i(D,{class:"stats-grid"},{default:u((()=>[i(D,{class:"stat-item"},{default:u((()=>[i(k,{class:"stat-value"},{default:u((()=>[o(d(C.submittedTables.length),1)])),_:1}),i(k,{class:"stat-label"},{default:u((()=>[o("总评分表")])),_:1})])),_:1}),i(D,{class:"stat-item"},{default:u((()=>[i(k,{class:"stat-value"},{default:u((()=>[o(d(S.expertCount),1)])),_:1}),i(k,{class:"stat-label"},{default:u((()=>[o("专家组")])),_:1})])),_:1}),i(D,{class:"stat-item"},{default:u((()=>[i(k,{class:"stat-value"},{default:u((()=>[o(d(S.publicCount),1)])),_:1}),i(k,{class:"stat-label"},{default:u((()=>[o("大众组")])),_:1})])),_:1}),i(D,{class:"stat-item"},{default:u((()=>[i(k,{class:"stat-value"},{default:u((()=>[o(d(C.totalProjects),1)])),_:1}),i(k,{class:"stat-label"},{default:u((()=>[o("项目数")])),_:1})])),_:1})])),_:1})])),_:1}),i(D,{class:"calculation-section uni-card"},{default:u((()=>[i(k,{class:"section-title"},{default:u((()=>[o("计算总分")])),_:1}),i(D,{class:"calculation-info"},{default:u((()=>[i(k,{class:"info-text"},{default:u((()=>[o("已收集 "+d(C.submittedTables.length)+" 份评分表",1)])),_:1}),i(k,{class:"info-text"},{default:u((()=>[o("专家组: "+d(S.expertCount)+" 人，大众组: "+d(S.publicCount)+" 人",1)])),_:1})])),_:1}),i(J,{onClick:S.calculateScores,disabled:0===C.submittedTables.length||C.calculating,class:"uni-btn uni-btn-success calculate-btn"},{default:u((()=>[o(d(C.calculating?"计算中...":"开始计算总分"),1)])),_:1},8,["onClick","disabled"])])),_:1}),C.calculationResult?(c(),l(D,{key:0,class:"result-section uni-card"},{default:u((()=>[i(D,{class:"section-header"},{default:u((()=>[i(k,{class:"section-title"},{default:u((()=>[o("计算结果")])),_:1}),i(k,{class:"result-meta"},{default:u((()=>[o("更新于: "+d(C.lastCalculated),1)])),_:1})])),_:1}),i(D,{class:"result-stats"},{default:u((()=>[i(k,{class:"stat"},{default:u((()=>[o("处理项目: "+d(C.calculationResult.total_projects)+" 个",1)])),_:1}),i(k,{class:"stat"},{default:u((()=>[o("有效评委: "+d(C.calculationResult.total_judges)+" 人",1)])),_:1}),i(k,{class:"stat"},{default:u((()=>[o("错误表数: "+d(C.calculationResult.errors)+" 个",1)])),_:1})])),_:1}),i(D,{class:"result-table"},{default:u((()=>[i(D,{class:"table-header"},{default:u((()=>[i(k,{class:"header-cell rank"},{default:u((()=>[o("排名")])),_:1}),i(k,{class:"header-cell name"},{default:u((()=>[o("项目名称")])),_:1}),i(k,{class:"header-cell score"},{default:u((()=>[o("总分")])),_:1})])),_:1}),(c(!0),h(f,null,g(C.calculationResult.data,((t,e)=>(c(),l(D,{key:e,class:r(["table-row",{"first-row":0===e,"second-row":1===e,"third-row":2===e}])},{default:u((()=>[i(k,{class:"cell rank"},{default:u((()=>[o(d(e+1),1)])),_:2},1024),i(k,{class:"cell name"},{default:u((()=>[o(d(t.项目名称||t.name),1)])),_:2},1024),i(k,{class:"cell score"},{default:u((()=>[o(d((t.总分||t.finalScore||0).toFixed(2)),1)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1}),i(J,{onClick:S.exportResults,class:"uni-btn uni-btn-warning export-btn"},{default:u((()=>[o("导出结果")])),_:1},8,["onClick"])])),_:1})):p("",!0),i(D,{class:"global-actions uni-card"},{default:u((()=>[i(k,{class:"section-title"},{default:u((()=>[o("系统操作")])),_:1}),i(D,{class:"action-buttons"},{default:u((()=>[i(J,{onClick:S.checkHealth,class:"uni-btn uni-btn-primary"},{default:u((()=>[o("检查服务状态")])),_:1},8,["onClick"]),i(J,{onClick:S.clearAllData,class:"uni-btn uni-btn-danger"},{default:u((()=>[o("清空所有数据")])),_:1},8,["onClick"]),i(J,{onClick:S.debugData,class:"uni-btn uni-btn-warning"},{default:u((()=>[o("调试数据")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-fe2cc91e"]]);export{S as default};
